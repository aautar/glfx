var glfx = (function (exports) {
  'use strict';

  var EPSILON=1e-6,ARRAY_TYPE="undefined"==typeof Float32Array?Array:Float32Array;Math.hypot||(Math.hypot=function(){for(var a=0,b=arguments.length;b--;)a+=arguments[b]*arguments[b];return Math.sqrt(a)});function create(){var a=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=0),a[0]=1,a[5]=1,a[10]=1,a[15]=1,a}function identity(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function multiply(c,d,a){var b=d[0],e=d[1],f=d[2],g=d[3],h=d[4],i=d[5],j=d[6],k=d[7],l=d[8],m=d[9],n=d[10],o=d[11],p=d[12],q=d[13],r=d[14],s=d[15],t=a[0],u=a[1],v=a[2],w=a[3];return c[0]=t*b+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,t=a[4],u=a[5],v=a[6],w=a[7],c[4]=t*b+u*h+v*l+w*p,c[5]=t*e+u*i+v*m+w*q,c[6]=t*f+u*j+v*n+w*r,c[7]=t*g+u*k+v*o+w*s,t=a[8],u=a[9],v=a[10],w=a[11],c[8]=t*b+u*h+v*l+w*p,c[9]=t*e+u*i+v*m+w*q,c[10]=t*f+u*j+v*n+w*r,c[11]=t*g+u*k+v*o+w*s,t=a[12],u=a[13],v=a[14],w=a[15],c[12]=t*b+u*h+v*l+w*p,c[13]=t*e+u*i+v*m+w*q,c[14]=t*f+u*j+v*n+w*r,c[15]=t*g+u*k+v*o+w*s,c}function translate(b,c,a){var d,e,f,g,h,i,j,k,l,m,n,o,p=a[0],q=a[1],r=a[2];return c===b?(b[12]=c[0]*p+c[4]*q+c[8]*r+c[12],b[13]=c[1]*p+c[5]*q+c[9]*r+c[13],b[14]=c[2]*p+c[6]*q+c[10]*r+c[14],b[15]=c[3]*p+c[7]*q+c[11]*r+c[15]):(d=c[0],e=c[1],f=c[2],g=c[3],h=c[4],i=c[5],j=c[6],k=c[7],l=c[8],m=c[9],n=c[10],o=c[11],b[0]=d,b[1]=e,b[2]=f,b[3]=g,b[4]=h,b[5]=i,b[6]=j,b[7]=k,b[8]=l,b[9]=m,b[10]=n,b[11]=o,b[12]=d*p+h*q+l*r+c[12],b[13]=e*p+i*q+m*r+c[13],b[14]=f*p+j*q+n*r+c[14],b[15]=g*p+k*q+o*r+c[15]),b}function scale(b,c,a){var d=a[0],e=a[1],f=a[2];return b[0]=c[0]*d,b[1]=c[1]*d,b[2]=c[2]*d,b[3]=c[3]*d,b[4]=c[4]*e,b[5]=c[5]*e,b[6]=c[6]*e,b[7]=c[7]*e,b[8]=c[8]*f,b[9]=c[9]*f,b[10]=c[10]*f,b[11]=c[11]*f,b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15],b}function rotate(b,d,a,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,u,v,w,A,B,C,D,E,F,G,H,I=e[0],J=e[1],K=e[2],L=Math.hypot(I,J,K);return L<EPSILON?null:(L=1/L,I*=L,J*=L,K*=L,f=Math.sin(a),g=Math.cos(a),h=1-g,i=d[0],j=d[1],k=d[2],l=d[3],m=d[4],n=d[5],o=d[6],p=d[7],q=d[8],r=d[9],u=d[10],v=d[11],w=I*I*h+g,A=J*I*h+K*f,B=K*I*h-J*f,C=I*J*h-K*f,D=J*J*h+g,E=K*J*h+I*f,F=I*K*h+J*f,G=J*K*h-I*f,H=K*K*h+g,b[0]=i*w+m*A+q*B,b[1]=j*w+n*A+r*B,b[2]=k*w+o*A+u*B,b[3]=l*w+p*A+v*B,b[4]=i*C+m*D+q*E,b[5]=j*C+n*D+r*E,b[6]=k*C+o*D+u*E,b[7]=l*C+p*D+v*E,b[8]=i*F+m*G+q*H,b[9]=j*F+n*G+r*H,b[10]=k*F+o*G+u*H,b[11]=l*F+p*G+v*H,d!==b&&(b[12]=d[12],b[13]=d[13],b[14]=d[14],b[15]=d[15]),b)}function perspective(a,b,c,d,e){var g,h=1/Math.tan(b/2);return a[0]=h/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=h,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=-1,a[12]=0,a[13]=0,a[15]=0,null!=e&&e!==1/0?(g=1/(d-e),a[10]=(e+d)*g,a[14]=2*e*d*g):(a[10]=-1,a[14]=-2*d),a}function ortho(a,b,c,d,e,f,g){var h=1/(b-c),i=1/(d-e),j=1/(f-g);return a[0]=-2*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*j,a[11]=0,a[12]=(b+c)*h,a[13]=(e+d)*i,a[14]=(g+f)*j,a[15]=1,a}function lookAt(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o=b[0],p=b[1],q=b[2],r=d[0],s=d[1],t=d[2],u=c[0],v=c[1],w=c[2];return Math.abs(o-u)<EPSILON&&Math.abs(p-v)<EPSILON&&Math.abs(q-w)<EPSILON?identity(a):(k=o-u,l=p-v,m=q-w,n=1/Math.hypot(k,l,m),k*=n,l*=n,m*=n,e=s*m-t*l,f=t*k-r*m,g=r*l-s*k,n=Math.hypot(e,f,g),n?(n=1/n,e*=n,f*=n,g*=n):(e=0,f=0,g=0),h=l*g-m*f,i=m*e-k*g,j=k*f-l*e,n=Math.hypot(h,i,j),n?(n=1/n,h*=n,i*=n,j*=n):(h=0,i=0,j=0),a[0]=e,a[1]=h,a[2]=k,a[3]=0,a[4]=f,a[5]=i,a[6]=l,a[7]=0,a[8]=g,a[9]=j,a[10]=m,a[11]=0,a[12]=-(e*o+f*p+g*q),a[13]=-(h*o+i*p+j*q),a[14]=-(k*o+l*p+m*q),a[15]=1,a)}var glfx={};glfx.version="0.3.1",glfx.echo=function(a){"undefined"!=typeof console.log&&console.log(a);},glfx.gl=null,glfx.rttprog=null,glfx.devicePixelRatio=window.devicePixelRatio||1,glfx.assetRef=0,glfx.onAssetsLoaded=function(){},glfx.onSceneRender=function(){},glfx.whenAssetsLoaded=function(a){"undefined"!=typeof a&&(0===glfx.assetRef?a():glfx.onAssetsLoaded=a);},glfx.incAssetRef=function(){glfx.assetRef++,0===glfx.assetRef&&(glfx.onAssetsLoaded(),glfx.onAssetsLoaded=function(){});},glfx.decAssetRef=function(){glfx.assetRef--;},glfx.shaders={},glfx.shaders.buffer=[],glfx.shaders.load=function(a,b,c,d){glfx.decAssetRef();var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var f=e.responseText,g=glfx.gl.createShader(c);glfx.gl.shaderSource(g,f),glfx.gl.compileShader(g),glfx.gl.getShaderParameter(g,glfx.gl.COMPILE_STATUS)||(glfx.echo("Failed to compile shader: "+a),g=null),"undefined"!=typeof d&&d(g),glfx.shaders.buffer[b]=g,glfx.incAssetRef();}},e.open("GET",a,!0),e.send();},glfx.shaders.createProgram=function(a,b){for(var c=glfx.gl.createProgram(),d=0;d<a.length;d++)glfx.gl.attachShader(c,a[d]);return (glfx.gl.linkProgram(c),!glfx.gl.getProgramParameter(c,glfx.gl.LINK_STATUS))?(glfx.echo("Could not create shader program, failed to link program."),null):(b(c),c)},glfx.textures={},glfx.textures.buffer=[],glfx.textures.load=function(a,b){glfx.decAssetRef(),glfx.textures.buffer[b]=glfx.gl.createTexture();var c=glfx.textures.buffer[b];c.image=new Image,c.image.onload=function(){var a=glfx.textures.buffer[b];glfx.gl.bindTexture(glfx.gl.TEXTURE_2D,a),glfx.gl.pixelStorei(glfx.gl.UNPACK_FLIP_Y_WEBGL,!0),glfx.gl.texImage2D(glfx.gl.TEXTURE_2D,0,glfx.gl.RGBA,glfx.gl.RGBA,glfx.gl.UNSIGNED_BYTE,a.image),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_MAG_FILTER,glfx.gl.LINEAR),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_MIN_FILTER,glfx.gl.LINEAR),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_WRAP_S,glfx.gl.CLAMP_TO_EDGE),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_WRAP_T,glfx.gl.CLAMP_TO_EDGE),glfx.gl.bindTexture(glfx.gl.TEXTURE_2D,null),glfx.incAssetRef();},c.image.src=a;},glfx.model=function(){this.vertexBuffer=null,this.indexBuffer=null,this.texcoordBuffer=null,this.normalBuffer=null;},glfx.models={},glfx.models.buffer=[],glfx.models.jsonParser=function(a){var b=JSON.parse(a);return glfx.models.jsonLoad(b)},glfx.models.jsonLoad=function(a){var b=a,c=new glfx.model;return c.vertexBuffer=glfx.gl.createBuffer(),glfx.gl.bindBuffer(glfx.gl.ARRAY_BUFFER,c.vertexBuffer),glfx.gl.bufferData(glfx.gl.ARRAY_BUFFER,new Float32Array(b.verts),glfx.gl.STATIC_DRAW),c.vertexBuffer.itemSize=3,c.vertexBuffer.numItems=b.verts.length/3,c.indexBuffer=glfx.gl.createBuffer(),glfx.gl.bindBuffer(glfx.gl.ELEMENT_ARRAY_BUFFER,c.indexBuffer),glfx.gl.bufferData(glfx.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.indices),glfx.gl.STATIC_DRAW),c.indexBuffer.itemSize=1,c.indexBuffer.numItems=b.indices.length,0<b.texcoords.length&&(c.texcoordBuffer=glfx.gl.createBuffer(),glfx.gl.bindBuffer(glfx.gl.ARRAY_BUFFER,c.texcoordBuffer),glfx.gl.bufferData(glfx.gl.ARRAY_BUFFER,new Float32Array(b.texcoords),glfx.gl.STATIC_DRAW),c.texcoordBuffer.itemSize=2,c.texcoordBuffer.numItems=b.texcoords.length/2),0<b.normals.length&&(c.normalBuffer=glfx.gl.createBuffer(),glfx.gl.bindBuffer(glfx.gl.ARRAY_BUFFER,c.normalBuffer),glfx.gl.bufferData(glfx.gl.ARRAY_BUFFER,new Float32Array(b.normals),glfx.gl.STATIC_DRAW),c.normalBuffer.itemSize=3,c.normalBuffer.numItems=b.normals/3),c},glfx.models.load=function(a,b,c,d){glfx.decAssetRef();var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var a=c(e.responseText);glfx.models.buffer[b]=a,"undefined"!=typeof d&&d(a),glfx.incAssetRef();}},e.open("GET",a,!0),e.send();},glfx.models.generateScreenQuadStrip=function(a,b){var c={};c.verts=[-1,1,0,-1,-1,0,1,-1,0,1,1,0],c.normals=[],c.indices=[0,1,3,2],c.texcoords=[0,1,0,0,1,0,1,1],glfx.models.buffer[a]=glfx.models.jsonLoad(c);},glfx.scene={},glfx.scene.ptime=0,glfx.scene.matCamera=null,glfx.scene.matModelView=null,glfx.scene.matPerspective=null,glfx.scene.graph=[],glfx.scene.rttTexture=null,glfx.scene.rttFramebuffer=null,glfx.scene.rttDepthBuffer=null,glfx.scene.onPostProcessPreDraw=function(){},glfx.scene.worldObject=function(a,b){this.base=a,this.shprog=b,this.position=vec3.create(),this.rotation=vec3.create(),this.scale=vec3.clone([1,1,1]),this.update=function(){},this.render=function(){};},glfx.scene.setPostProcessShaderProgram=function(a){glfx.rttprog=a;},glfx.scene.addWorldObject=function(a){glfx.scene.graph.push(a);},glfx.setFOV=function(a){perspective(glfx.scene.matPerspective,a,glfx.gl.viewportWidth/glfx.gl.viewportHeight,.1,1e3);},glfx.setClearColor=function(a){glfx.gl.clearColor(a[0],a[1],a[2],a[3]);},glfx.initRTTFrameBuffer=function(a,b){var c=glfx.gl.createFramebuffer();return glfx.gl.bindFramebuffer(glfx.gl.FRAMEBUFFER,c),c.width=a,c.height=b,c},glfx.initRTTTexture=function(a){var b=glfx.gl.createTexture();return glfx.gl.bindTexture(glfx.gl.TEXTURE_2D,b),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_MAG_FILTER,glfx.gl.LINEAR),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_MIN_FILTER,glfx.gl.LINEAR),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_WRAP_S,glfx.gl.CLAMP_TO_EDGE),glfx.gl.texParameteri(glfx.gl.TEXTURE_2D,glfx.gl.TEXTURE_WRAP_T,glfx.gl.CLAMP_TO_EDGE),glfx.gl.texImage2D(glfx.gl.TEXTURE_2D,0,glfx.gl.RGBA,a.width,a.height,0,glfx.gl.RGBA,glfx.gl.UNSIGNED_BYTE,null),glfx.gl.bindTexture(glfx.gl.TEXTURE_2D,null),b},glfx.initRTTDepthBuffer=function(a){var b=glfx.gl.createRenderbuffer();return glfx.gl.bindRenderbuffer(glfx.gl.RENDERBUFFER,b),glfx.gl.renderbufferStorage(glfx.gl.RENDERBUFFER,glfx.gl.DEPTH_COMPONENT16,a.width,a.height),b},glfx.init=function(a,b,c,d){if(glfx.gl=a.getContext("experimental-webgl",{antialias:!0}),!glfx.gl)return glfx.echo("No webGL support."),!1;a.style.width=b+"px",a.style.height=c+"px";var e=b*glfx.devicePixelRatio,f=c*glfx.devicePixelRatio;return a.setAttribute("width",e),a.setAttribute("height",f),glfx.gl.viewportWidth=e,glfx.gl.viewportHeight=f,glfx.setClearColor([1,1,1,1]),glfx.gl.enable(glfx.gl.DEPTH_TEST),glfx.scene.matPerspective=create(),glfx.scene.matModelView=create(),glfx.scene.matCamera=create(),glfx.setFOV(1.57079633),glfx.scene.rttFramebuffer=glfx.initRTTFrameBuffer(glfx.gl.viewportWidth,glfx.gl.viewportHeight),glfx.scene.rttTexture=glfx.initRTTTexture(glfx.scene.rttFramebuffer),glfx.scene.rttDepthBuffer=glfx.initRTTDepthBuffer(glfx.scene.rttFramebuffer),glfx.gl.framebufferTexture2D(glfx.gl.FRAMEBUFFER,glfx.gl.COLOR_ATTACHMENT0,glfx.gl.TEXTURE_2D,glfx.scene.rttTexture,0),glfx.gl.framebufferRenderbuffer(glfx.gl.FRAMEBUFFER,glfx.gl.DEPTH_ATTACHMENT,glfx.gl.RENDERBUFFER,glfx.scene.rttDepthBuffer),glfx.models.generateScreenQuadStrip("rttquad"),glfx.gl.bindTexture(glfx.gl.TEXTURE_2D,null),glfx.gl.bindRenderbuffer(glfx.gl.RENDERBUFFER,null),glfx.gl.bindFramebuffer(glfx.gl.FRAMEBUFFER,null),"undefined"!=typeof d&&d(),glfx.render(0),!0},glfx.resetCamera=function(){glfx.scene.matCamera=create();},glfx.translateCamera=function(a){translate(glfx.scene.matCamera,glfx.scene.matCamera,a);},glfx.rotateCamera=function(a,b){rotate(glfx.scene.matCamera,glfx.scene.matCamera,a,b);},glfx.renderToFrameBuffer=function(a,b){glfx.gl.bindFramebuffer(glfx.gl.FRAMEBUFFER,a),glfx.gl.viewport(0,0,glfx.gl.viewportWidth,glfx.gl.viewportHeight),glfx.gl.clear(glfx.gl.COLOR_BUFFER_BIT|glfx.gl.DEPTH_BUFFER_BIT);for(var c=0;c<glfx.scene.graph.length;c++){if(glfx.scene.matModelView=create(),multiply(glfx.scene.matModelView,glfx.scene.matModelView,glfx.scene.matCamera),glfx.scene.graph[c].update(b,glfx.scene.graph[c]),glfx.scene.graph[c].matTransform)multiply(glfx.scene.matModelView,glfx.scene.matModelView,glfx.scene.graph[c].matTransform);else{var d=glfx.scene.graph[c].position,e=glfx.scene.graph[c].rotation,f=glfx.scene.graph[c].scale;scale(glfx.scene.matModelView,glfx.scene.matModelView,f),translate(glfx.scene.matModelView,glfx.scene.matModelView,d),rotate(glfx.scene.matModelView,glfx.scene.matModelView,e[0],[1,0,0]),rotate(glfx.scene.matModelView,glfx.scene.matModelView,e[1],[0,1,0]),rotate(glfx.scene.matModelView,glfx.scene.matModelView,e[2],[0,0,1]);}glfx.scene.graph[c].render(b,glfx.scene.graph[c],glfx.scene.matModelView,glfx.scene.matPerspective);}},glfx.render=function(a){if(requestAnimationFrame(glfx.render),!(0>glfx.assetRef)){var b=0;0<glfx.scene.ptime&&(b=a-glfx.scene.ptime),glfx.scene.ptime=a,null===glfx.rttprog?glfx.renderToFrameBuffer(null,b):(glfx.renderToFrameBuffer(glfx.scene.rttFramebuffer,b),glfx.renderViewportQuad(glfx.scene.rttTexture,glfx.rttprog,b)),glfx.onSceneRender(b);}},glfx.renderViewportQuad=function(a,b,c){if(null===b)return glfx.echo("glfx.renderViewportQuad failed, _shaderProgram is null"),!1;if(null===a)return glfx.echo("glfx.renderViewportQuad failed, _texture is null"),!1;glfx.gl.bindFramebuffer(glfx.gl.FRAMEBUFFER,null),glfx.gl.viewport(0,0,glfx.gl.viewportWidth,glfx.gl.viewportHeight),glfx.gl.clear(glfx.gl.COLOR_BUFFER_BIT|glfx.gl.DEPTH_BUFFER_BIT);var d=glfx.models.buffer.rttquad,e=create();ortho(e,-1,1,-1,1,.1,-100);var f=create();return lookAt(f,vec3.clone([0,0,0]),vec3.clone([0,0,-1]),vec3.clone([0,1,0])),glfx.gl.useProgram(b),glfx.gl.activeTexture(glfx.gl.TEXTURE0),glfx.gl.bindTexture(glfx.gl.TEXTURE_2D,a),glfx.gl.uniform1i(b.samplerUniform,0),glfx.gl.bindBuffer(glfx.gl.ARRAY_BUFFER,d.vertexBuffer),glfx.gl.vertexAttribPointer(b.vertexPositionAttribute,d.vertexBuffer.itemSize,glfx.gl.FLOAT,!1,0,0),glfx.gl.bindBuffer(glfx.gl.ARRAY_BUFFER,d.texcoordBuffer),glfx.gl.vertexAttribPointer(b.textureCoordAttribute,d.texcoordBuffer.itemSize,glfx.gl.FLOAT,!1,0,0),glfx.gl.uniformMatrix4fv(b.pMatrixUniform,!1,e),glfx.gl.uniformMatrix4fv(b.mvMatrixUniform,!1,f),glfx.gl.bindBuffer(glfx.gl.ELEMENT_ARRAY_BUFFER,d.indexBuffer),glfx.scene.onPostProcessPreDraw(c),glfx.gl.drawElements(glfx.gl.TRIANGLE_STRIP,d.indexBuffer.numItems,glfx.gl.UNSIGNED_SHORT,0),!0};

  exports.glfx = glfx;

  return exports;

}({}));
//# sourceMappingURL=glfx.min.js.map
